name: "JFrog-GitHub NPM Publish OIDC Integration"
on: push

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OIDC_AUDIENCE: 'jfrog-oidc'
      OIDC_PROVIDER: 'alex-github'
      PLATFORM_REPO: 'alex-libs-release'
      # 从仓库密钥读取（值形如 https://demo.jfrogchina.com）
      JF_URL: ${{ secrets.JF_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Setup JFrog CLI (OIDC)
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ env.JF_URL }}
        with:
          oidc-provider-name: ${{ env.OIDC_PROVIDER }}
          oidc-audience: ${{ env.OIDC_AUDIENCE }}

      # 这步生成全局 settings.xml，不需要在 ./package 下跑
      - name: Configure Maven (global)
        working-directory: .
        run: |
          jf mvnc \
            --repo-resolve-releases  "$PLATFORM_REPO" \
            --repo-resolve-snapshots "$PLATFORM_REPO" \
            --repo-deploy-releases   "$PLATFORM_REPO" \
            --repo-deploy-snapshots  "$PLATFORM_REPO"
      - name: Build with Maven
        run: |
          jf mvn -B -U -DskipTests install
